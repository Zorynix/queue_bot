# Queue Bot - Автоматический Телеграм Бот для Управления Очередями

Телеграм-бот, который автоматически управляет очередями на сдачу работ по различным предметам с интеграцией Google Sheets.

## Функционал

- **Автоматические уведомления** - бот отправляет уведомления за 24 часа до начала предмета
- **Запись в очередь** - студенты записываются в очередь нажатием кнопки
- **Автоматическая запись в Google Sheets** - все записи синхронизируются с таблицей
- **Автоматическая очистка** - после окончания предмета очередь и столбец в таблице очищаются
- **Сопоставление имен** - бот определяет реальное имя студента по профилю или через маппинг

## Подготовка к работе

### 1. Создание Telegram бота

1. Найдите бота @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен

### 2. Настройка Google Sheets

1. Создайте новую Google Sheets таблицу
2. В первой строке укажите названия предметов в качестве заголовков столбцов
3. Скопируйте ID таблицы из URL (между `/spreadsheets/d/` и `/edit`)

### 3. Настройка Google Service Account

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Sheets API для проекта
4. Создайте Service Account:
   - IAM & Admin → Service Accounts → Create Service Account
   - Укажите имя и описание
   - Создайте и скачайте JSON ключ
5. Откройте вашу Google Sheets таблицу и предоставьте доступ для редактирования Service Account (используйте email из JSON файла)

## Установка и запуск

1. Установите Go (версия 1.22 или выше)

2. Клонируйте проект:
```bash
git clone <repository_url>
cd queue-bot
```

3. Установите зависимости:
```bash
go mod tidy
```

4. Настройте переменные окружения:
```bash
cp .env.example .env
# Отредактируйте .env файл, указав ваши значения
```

5. Создайте файл маппинга пользователей (опционально):
```bash
cp user_mapping.json.example user_mapping.json
# Отредактируйте user_mapping.json, добавив соответствия username → реальное имя
```

6. Убедитесь, что файл `queue_lessons.txt` содержит список предметов в формате CSV:
```
день_недели,время_начала,"Название предмета",время_окончания
вт,18:00,"Микросервисная архитектура",19:30
ср,12:40,"Стандартизация и сертификация ПО",14:10
ср,14:20,"Сопровождение программных систем",15:50
```
Дни недели: пн, вт, ср, чт, пт, сб, вс

7. Запустите бота:
```bash
# Через переменные окружения
export TELEGRAM_BOT_TOKEN="your_token"
export GOOGLE_SHEETS_ID="your_sheets_id"
export GOOGLE_CREDENTIALS_FILE="/path/to/credentials.json"
go run main.go

# Или загрузите переменные из .env файла (требует дополнительной библиотеки)
```

## Использование

### Автоматический процесс работы:

1. **За 24 часа до предмeta** - бот автоматически отправляет уведомление в указанный чат/группу
2. **Запись в очередь** - студенты нажимают кнопку "Записаться в очередь" в уведомлении
3. **Подтверждение** - бот сообщает о успешной записи и месте в очереди
4. **Синхронизация** - данные автоматически записываются в Google Sheets
5. **Автоочистка** - после окончания предмета очередь и столбец в таблице очищаются

### Особенности:

- Бот работает полностью автономно, не требует вмешательства администратора
- Каждый студент может записаться в очередь только один раз на предмет
- Показывается номер места в очереди при записи
- Все действия логируются для контроля

## Определение имени студента

Бот определяет реальное имя студента в следующем порядке:

1. **Маппинг пользователей** - проверяет файл `user_mapping.json` на наличие соответствия Telegram username → реальное имя
2. **Имя из профиля** - использует имя и фамилию из Telegram профиля студента
3. **Username** - использует @username если другие варианты недоступны


## Переменные окружения

- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `QUEUE_CHAT_ID` - ID чата или группы для отправки уведомлений (начинается с -)  
- `GOOGLE_SHEETS_ID` - ID Google Sheets таблицы
- `GOOGLE_CREDENTIALS_FILE` - путь к JSON файлу с credentials Service Account
- `GOOGLE_CREDENTIALS_JSON` - содержимое JSON файла credentials (альтернатива файлу)

## Формат Google Sheets

Таблица должна иметь следующую структуру:
- Столбец A: номера студентов в группе
- Остальные столбцы: короткие названия предметов в качестве заголовков
- Студенты записываются в соответствующий столбец под заголовком предмета

### Маппинг предметов на столбцы:
- "Микросервисная архитектура" → столбец "Микросервисы"
- "Стандартизация и сертификация программного обеспечения" → столбец "СИСПО"
- "Сопровождение программных систем" → столбец "СПС"
- "Управление информационно-технологическими проектами" → столбец "УИТП"
- "Оценка параметров функционирования программных систем" → столбец "ОПФПС"
- "Проектирование программных систем" → столбец "ППС"

## Безопасность

- Все токены и credentials передаются через переменные окружения
- Google Service Account имеет доступ только к указанной таблице
- Операции с Google Sheets защищены от одновременного доступа

## Логирование

Бот ведет подробные логи всех операций:
- Загрузка предметов и маппинга пользователей
- Успешные записи в Google Sheets
- Ошибки при работе с API

## Требования

- Go 1.22+
- Доступ к интернету для работы с Telegram Bot API и Google Sheets API
- Google Service Account с доступом к Google Sheets API